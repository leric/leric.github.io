---
import SidebarLayout from "../../../layouts/SidebarLayout.astro";
import PostCard from "../../../components/PostCard.astro";
import { SITE_TITLE } from "../../../consts";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
    const allPosts = await getCollection("blog");
    const uniqueTags = [
        ...new Set(allPosts.flatMap((post) => post.data.tags || [])),
    ];

    return uniqueTags.map((tag) => {
        const filteredPosts = allPosts.filter((post) =>
            (post.data.tags || []).includes(tag),
        );
        return {
            params: { tag },
            props: { posts: filteredPosts },
        };
    });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
const sortedPosts = posts.sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);
---

<SidebarLayout
    title={`${tag} - ${SITE_TITLE}`}
    description={`Posts tagged with ${tag}`}
    headerTitle={`Topic: ${tag}`}
    headerSubtitle={`${posts.length} articles tagged with "${tag}"`}
>
    <div class="posts-archive">
        {
            sortedPosts.map((post) => (
                <PostCard
                    title={post.data.title}
                    description={post.data.description}
                    pubDate={post.data.pubDate}
                    heroImage={post.data.heroImage}
                    slug={post.id}
                    category={post.data.category}
                />
            ))
        }
    </div>
</SidebarLayout>

<style>
    .posts-archive {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    @media (max-width: 768px) {
        .posts-archive {
            gap: 20px;
        }
    }
</style>
